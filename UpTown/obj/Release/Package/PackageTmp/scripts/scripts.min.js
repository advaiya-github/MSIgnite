// Setup Variables
var $window = $(window),
$body = $('body'),
meBPoint = 280, //Mobile viewport breakpoint
tbBPoint = 960, //Mobile viewport breakpoint
wWidth = $(window).width(),
wHeight = $(window).height(),
headerHeight = $('#menu-wrapper').outerHeight(),
speakerOffsetTop,
activeLinkFlag = true,
sliderSpeakScroll = true,
speakerArrowDefault = true,
sliderSpeak,
sliderSpeakQty = 0,
sliderSpeakIndex = 0,
mobileTablet=false,
$heroBlade;

var MicrosoftIgnite = MicrosoftIgnite || {};
(function($) {
    "use strict";

    MicrosoftIgnite.init = function() {
        MicrosoftIgnite.speakersCarousel.init();
        MicrosoftIgnite.generalBehavior();
        MicrosoftIgnite.menuBehavior();
        MicrosoftIgnite.modal();
    }

    MicrosoftIgnite.speakersCarousel = MicrosoftIgnite.speakersCarousel || {};

    MicrosoftIgnite.speakersCarousel.defaultSrc = function(dataAttr) {
        $('.speakers-images .speaker').each(function(index, val) {
            var defaultSrc = $(this).data(dataAttr);
            $(this).children('img').attr('src', defaultSrc);
        });
    }

    MicrosoftIgnite.speakersCarousel.init = function() {
        sliderSpeakQty = $('.speakers-images .speaker').length-1;
        var sliderSpeakConfigObj;
        if (wWidth < meBPoint) { //Mobile Behaviour
            $('.speaker-content .content:first-child').addClass('active');

            sliderSpeakConfigObj = {
                minSlides: 1,
                maxSlides: 5,
                slideWidth: 170,
                moveSlides: 1,
                pager: false,
                controls: false,
                infiniteLoop: false,
                onSlideNext: function(newIndex){
                    $('.speaker-content .content').removeClass('active');
                    $('.speaker-content .content[data-position-index="'+newIndex.data('position-index')+'"]').addClass('active');
                },
                onSlidePrev: function(newIndex){
                    $('.speaker-content .content').removeClass('active');
                    $('.speaker-content .content[data-position-index="'+newIndex.data('position-index')+'"]').addClass('active');
                }
            }

            MicrosoftIgnite.speakersCarousel.defaultSrc('active-src');
            
            $('.why-speaker-more').on('click', function(event) {
                event.preventDefault();
                var $learnBtn = $('.why-speaker-more');
                if (!$learnBtn.hasClass('active')){
                    $learnBtn.text('Close').addClass('active').next('.why-speaker-story').slideDown();
                }else{
                    $learnBtn.text('Learn More').removeClass('active').next('.why-speaker-story').slideUp();
                }                
            });

            $('.speakers-images .speaker').addClass('active');

            $('.speakers-carousel').on('click', '.bx-prev', function(event) {
                event.preventDefault();
                sliderSpeakIndex = sliderSpeak.getCurrentSlide();
                if (sliderSpeakIndex > 0){
                    sliderSpeakIndex--;
                }else{
                    sliderSpeakIndex = sliderSpeakQty;
                }
                sliderSpeak.goToSlide(sliderSpeakIndex);
                $('.speaker-content .content').removeClass('active');
                $('.speaker-content .content[data-position-index="'+sliderSpeakIndex+'"]').addClass('active');
            });

            $('.speakers-carousel').on('click', '.bx-next', function(event) {
                event.preventDefault();
                sliderSpeakIndex = sliderSpeak.getCurrentSlide();
                if (sliderSpeakIndex < sliderSpeakQty){
                    sliderSpeakIndex++;
                }else{
                    sliderSpeakIndex = 0;
                }
                sliderSpeak.goToSlide(sliderSpeakIndex);
                $('.speaker-content .content').removeClass('active');
                $('.speaker-content .content[data-position-index="'+sliderSpeakIndex+'"]').addClass('active');
            });

        } else { //Desktop behaviour
            sliderSpeakConfigObj = {
                minSlides: 1,
                maxSlides: 5,
                slideWidth: 170,
                moveSlides: 1,
                pager: false,
                controls: false,
                infiniteLoop: true
            }

            speakerOffsetTop = $('#why-speakers-featured').offset().top;
            MicrosoftIgnite.speakersCarousel.defaultSrc('default-src');
            $('.speakers-images').on('click', '.speaker', function(event) {                
                event.preventDefault();
                speakerArrowDefault = false;
                if ($(this).hasClass('active')) {
                    closeContents();
                    speakerArrowDefault = true;
                } else {
                    sliderSpeakIndex = $(this).data('position-index');                    
                    var $slideClickedEl = $(this);
                    if($(this).hasClass('bx-clone')){
                        $slideClickedEl = $('.speakers-images .speaker:not(".bx-clone")[data-position-index="'+sliderSpeakIndex+'"]');
                        sliderSpeak.goToSlide(sliderSpeakIndex);
                    }
                    
                    $('.speakers-images .speaker').removeClass('active');
                    $slideClickedEl.addClass('active');
                    MicrosoftIgnite.speakersCarousel.defaultSrc('default-src');
                    var activeSrc = $slideClickedEl.data('active-src');
                    var dest = $slideClickedEl.data('dest');
                    $slideClickedEl.children('img').attr('src', activeSrc);
                    $('.speaker-content .content').removeClass('active');
                    TweenLite.to(".speaker-content", 0.5, {
                        height: 'auto',//$(dest).outerHeight(),
                        onComplete: function() {
                            $(dest).addClass('active');
                        }
                    });

                    if(sliderSpeakScroll){
                        speakerOffsetTop = $('#why-speakers-featured').offset().top;
                        headerHeight = $('#menu-wrapper').outerHeight();                    
                        TweenLite.to('html, body', 0.5, {
                            scrollTop: speakerOffsetTop-headerHeight,
                            onComplete: function(){
                                speakerOffsetTop = $('#why-speakers-featured').offset().top;
                                headerHeight = $('#menu-wrapper').outerHeight();
                                TweenLite.to('html, body', 0.5, {
                                    scrollTop: speakerOffsetTop,
                                    onComplete: function(){
                                        sliderSpeakScroll = false;
                                    }
                                });
                            }
                        });
                    }

                }
            });

            $(window).scroll(function(event) {
               sliderSpeakScroll = true;
            });

            $('.speaker-content').on('click', '.close-speaker', function(event) {
                event.preventDefault();
                speakerArrowDefault = true;
                $(this).parents('.content').removeClass('active');
                TweenLite.to(".speaker-content", 0.5, {
                    height: 0
                });
                $('.speakers-images .speaker').removeClass('active');
                MicrosoftIgnite.speakersCarousel.defaultSrc('default-src');
            });

            $('.speakers-carousel').on('click', '.bx-prev', function(event) {
                event.preventDefault();
                if(speakerArrowDefault){
                    sliderSpeak.goToPrevSlide();
                }else{
                    if (sliderSpeakIndex > 0){
                        sliderSpeakIndex--;
                    }else{
                        sliderSpeakIndex = sliderSpeakQty;
                    }
                    sliderSpeak.goToSlide(sliderSpeakIndex);
                    $('.speakers-images .speaker:not(".bx-clone")[data-position-index="'+sliderSpeakIndex+'"]').trigger('click');
                }
            });

            $('.speakers-carousel').on('click', '.bx-next', function(event) {
                event.preventDefault();
                if(speakerArrowDefault){
                    sliderSpeak.goToNextSlide();
                }else{
                    if (sliderSpeakIndex < sliderSpeakQty){
                        sliderSpeakIndex++;
                    }else{
                        sliderSpeakIndex = 0;
                    }
                    sliderSpeak.goToSlide(sliderSpeakIndex);
                    $('.speakers-images .speaker:not(".bx-clone")[data-position-index="'+sliderSpeakIndex+'"]').trigger('click');
                }
            });

            $('.speakers-images').on({
                mouseenter: function () {
                    if($(this).hasClass('active')){
                        return false
                    }
                    $(this).children('img').attr('src', $(this).data('active-src') );
                },
                mouseleave: function () {
                    if($(this).hasClass('active')){
                        return false
                    }
                    $(this).children('img').attr('src', $(this).data('default-src') );
                }
            },'.speaker');
        }

        sliderSpeak = $('.speakers-images').bxSlider(sliderSpeakConfigObj);

        function closeContents() {
            $('.speakers-images .speaker').removeClass('active');
            $('.speaker-content .content').removeClass('active');
            MicrosoftIgnite.speakersCarousel.defaultSrc('default-src');
            TweenLite.to(".speaker-content", 0.5, {
                height: 0
            });
        }
    }

    MicrosoftIgnite.parallax = function() {
        var parallaxSpeedFactor = $('[data-behavior="blade"]').first().data('parallax-factor'),
        parallaxSpeedFactor2 = $('[data-behavior="blade"]').first().data('parallax-factor');
        if ($('[data-behavior="blade"]').length) {            
            if(wHeight < 768){
                $('body').addClass('parallax-short');  
            }else{
                $('body').addClass('parallax-tall');  
            }
            TweenLite.to($('[data-behavior="blade"]').first(), 0.5, {
                height: wHeight,
                onComplete:function(){
                    if ($('body').hasClass('parallax-tall')){
                        //Positioning hero text div
                        $heroBlade = $('[data-behavior="blade"]').first();
                        var $heroTextDiv =  $heroBlade.find('.grid-hero'),
                        heroTextTop = ( (wHeight-$heroTextDiv.height())/2 )*1.10;
                        TweenLite.to($heroTextDiv,0.5,{paddingTop: heroTextTop});
                    }                    

                    speakerOffsetTop = $('#why-speakers-featured').offset().top;
                    $('[data-blade-name]').each(function() {             
                         var $bladeNameEl = $(this);
                         $(window).scroll(function() {
                            if(activeLinkFlag){
                                var bladeNameTopPos = $bladeNameEl.offset().top,
                                bladeNameHeight = $bladeNameEl.outerHeight(),
                                bladeNamedata = $bladeNameEl.data('blade-name'),
                                wScrollPos = $window.scrollTop()+headerHeight,
                                bladeNameTopPos2 = bladeNameTopPos;
                                if($bladeNameEl.data('active-menu-top')){                                    
                                    bladeNameTopPos = ($bladeNameEl.parents('[data-behavior="blade"]').offset().top)+(($bladeNameEl.parents('[data-behavior="blade"]').offset().top)/2);                                    
                                }
                                if (wScrollPos > bladeNameTopPos && wScrollPos < (bladeNameHeight+bladeNameTopPos2) ) {
                                    $('[class*="bladename-"]').removeClass('active');
                                    $('.bladename-'+bladeNamedata).addClass('active');
                                }
                            }
                        });
                    });
                }
            });            
            $('[data-behavior="blade"]').each(function(index) {
                var $blade = $(this),
                    bladeContent = '[data-behavior="blade-content"]',
                    topPercentage = 1,
                    bladeIndex = index;
                $blade.css({
                    position: 'relative',
                    overflow: 'hidden',
                    zIndex: index
                }).find(bladeContent).css({
                    position: 'relative',
                    top: 0
                });
                if (bladeIndex < $('[data-behavior="blade"]').length - 2) {
                    $blade.addClass('applicable');
                }
                $(window).scroll(function() {
                    var bladeTopPos = $blade.offset().top;
                    var windowScrollPos = $window.scrollTop();
                    if (windowScrollPos > bladeTopPos) {
                        if ($blade.hasClass('applicable')) {
                            if($blade.data('parallax-custom-factor')){
                                parallaxSpeedFactor2 =    $blade.data('parallax-custom-factor');    
                                $blade.find(bladeContent).css({
                                    top: (windowScrollPos - bladeTopPos) / parallaxSpeedFactor2 + 'px'
                                });                 
                            }else{
                                $blade.find(bladeContent).css({
                                    top: (windowScrollPos - bladeTopPos) / parallaxSpeedFactor + 'px'
                                });
                            }
                            
                        }
                    } else {
                        $blade.find(bladeContent).css({
                            top: 0
                        });
                    }
                });
            });
            $(window).resize(function(event) {                
                $('body').removeClass('parallax-short parallax-tall');
                if(wHeight < 768){
                    $('body').addClass('parallax-short');
                    $('.grid-hero').removeAttr('style');
                }else{
                    $('body').addClass('parallax-tall');
                    //Positioning hero text div
                    $heroBlade = $('[data-behavior="blade"]').first();
                    var $heroTextDiv =  $heroBlade.find('.grid-hero'),
                    heroTextTop = ( (wHeight-$heroTextDiv.height())/2 )*1.10;
                    TweenLite.to($heroTextDiv,0.5,{paddingTop: heroTextTop});
                }
                
            });
        }
    }

    MicrosoftIgnite.backgroundAnimation = function() {
        $('[data-type="background"]').each(function() {
            var $bgblade = $(this),
            bgDirection = $(this).data('direction'),
            bgPosition = 0;
            switch (bgDirection) {
                case "left-right":
                $bgblade.css({ backgroundPosition: bgPosition+'% 100%'});
                break;                
                case "bottom-top":
                $bgblade.css({ backgroundPosition: 'center -'+bgPosition+'%'});
                break;
                case "top-bottom":
                $bgblade.css({ backgroundPosition: 'center '+bgPosition+'%'});
                break;
            }
            var lastTopScrollTop = 0;
            $(window).scroll(function() {
                moveBladeBg($bgblade,bgDirection);
            });

            function moveBladeBg($bgbladeEl,bgELDirection){
                var bgBladeTopPos = $bgbladeEl.parent().offset().top,
                bgBladeHeight = $bgbladeEl.outerHeight(),
                wTop = $window.scrollTop(),
                bgSpeed = $bgbladeEl.data('background-speed');
                if($bgbladeEl.hasClass('selfmoved')){
                    bgBladeTopPos = $bgbladeEl.offset().top;
                }
                if ( (wTop+wHeight > bgBladeTopPos) && ( wTop < (bgBladeTopPos+bgBladeHeight) ) && (wTop >0 ) ) {
                    if (wTop > lastTopScrollTop){
                        if(bgPosition < 100){ bgPosition = bgPosition+bgSpeed; }                        
                    } else {
                        if(bgPosition > 0){ bgPosition = bgPosition-bgSpeed; }                
                    }
                    switch (bgELDirection) {
                        case "left-right":
                        $bgblade.css({ backgroundPosition: bgPosition+'% 100%'});
                        break;                
                        case "bottom-top":
                        $bgblade.css({ backgroundPosition: 'center -'+bgPosition+'%'});
                        break;
                        case "top-bottom":
                        $bgblade.css({ backgroundPosition: 'center '+bgPosition+'%'});
                        break;
                    }
                    lastTopScrollTop = wTop;
                }else{
                    switch (bgELDirection) {
                        case "left-right":
                        $bgblade.css({ backgroundPosition: '0% 100%'});
                        break;                
                        case "bottom-top":
                        $bgblade.css({ backgroundPosition: 'center 0%'});
                        bgPosition = 0;
                        break;
                        case "top-bottom":
                        $bgblade.css({ backgroundPosition: 'center 0%'});
                        break;
                    }
                }
            }

        });
    }

    MicrosoftIgnite.generalBehavior = function() {
        $('.menu-items, .menu-title').on('click', 'a:not(.btn-burger)', function(event) {
            activeLinkFlag = false;
            event.preventDefault();
            $('.mobile-menu').css('height', 0);
            var href = $(this).attr('href');
            $('[class*="bladename-"]').removeClass('active');
            $(this).addClass('active');
            $('.btn-burger').removeClass('active');
            headerHeight = $('#menu-wrapper').outerHeight(); 
            wHeight = $(window).height();
            var scrollToSection = $($.attr(this, 'href')).parents('[data-behavior="blade"]').offset().top - headerHeight +1;
            if(mobileTablet){
                if ($(this).data('anchor-bottom')){
                    scrollToSection = $($.attr(this, 'href')).offset().top - headerHeight +2;
                } 
            }else{
                if ($(this).data('anchor-bottom')){
                    scrollToSection = $($.attr(this, 'href')).parents('[data-behavior="blade"]').next('[data-behavior="blade"]').offset().top - wHeight;
                }  
            }            
            TweenLite.to('html, body', 0.5, {
                scrollTop: scrollToSection,
                onComplete: function(){
                    setTimeout(function(){activeLinkFlag=true}, 500);

                }
            });
        });

        $('[data-animated-anchor]').on('click', function(event) {
            event.preventDefault();
            var href = $(this).attr('href');
            headerHeight = $('#menu-wrapper').outerHeight(); 
            wHeight = $(window).height();
            var scrollToSection = $($.attr(this, 'href')).parents('[data-behavior="blade"]').offset().top - headerHeight +1;
            if ($(this).data('anchor-bottom')){
                scrollToSection = ($($.attr(this, 'href')).parents('[data-behavior="blade"]').next('[data-behavior="blade"]').offset().top - wHeight)+1;
            }
            TweenLite.to('html, body', 0.5, {
                scrollTop: scrollToSection
            });
        });

        if (navigator.userAgent.indexOf('Safari') !== -1 && navigator.userAgent.indexOf('Chrome') === -1) {
            $('body').addClass('safari');
        }


    }

    MicrosoftIgnite.modal = function() {
        $('body').on('click', '.modal-link', function(event) {
            event.preventDefault();
            wWidth = $(window).width();
            var mTarget = $(this).data('modal-target'),            
            $modalEl = $(mTarget);
            $modalEl.show();
            $('.modal-overlay').fadeIn(function() {
                $modalEl.show(function(){
                    var modalW = $modalEl.width(),
                    modalLeft = (wWidth-modalW)/2;
                    if (wWidth <= meBPoint){
                        modalLeft='5%';
                        $modalEl.css('width','90%');
                    }
                    $modalEl.css('left',modalLeft);
                });
            });
        });

        $('body').on('click', '.close-modal', function(event) {
            event.preventDefault();
            $('.modal-overlay, .modal-box').fadeOut();
        });

        $(window).resize(function(event) {
            wWidth = $(window).width();
            $('.modal-box').each(function() {
                var $modalEl = $(this),
                modalW = $modalEl.width(),
                modalLeft = (wWidth-modalW)/2;
                if (wWidth <= meBPoint){
                    modalLeft='5%';
                    $modalEl.css('width','90%');
                }
                $modalEl.css('left',modalLeft);
            });         
        });


    }

    MicrosoftIgnite.menuBehavior = function() {
        if (wWidth < tbBPoint){
            $('.mobile-menu').removeAttr('style');
            $('.menu-wrapper').off();

            var mobileMenuHeight = $('.mobile-menu').outerHeight();
            $('.mobile-menu').css({
                display: 'block',
                overflow: 'hidden',
                height: 0
            });

            $('.menu-wrapper').on('click', '.btn-burger', function(event) {
                event.preventDefault();
                var $burgerBtn = $(this);
                if(!$burgerBtn.hasClass('active')){
                    $burgerBtn.addClass('active');
                    TweenLite.to('.mobile-menu', 0.5, {
                        height: mobileMenuHeight
                    });
                }else{
                    $burgerBtn.removeClass('active');
                    TweenLite.to('.mobile-menu', 0.5, {
                        height: 0
                    });
                }
                
            });
        }else{
            $('.mobile-menu').removeAttr('style');
            $('.menu-wrapper').off();
        }
    }

    $(document).ready(function() {
        var md = new MobileDetect(navigator.userAgent);
        if ( md.mobile() || md.phone() || md.tablet() ){
            mobileTablet=true;
        }
        MicrosoftIgnite.init();
    });

    $(window).load(function() {
        if (!mobileTablet) {
            MicrosoftIgnite.parallax();  
            MicrosoftIgnite.backgroundAnimation();
        }else{
            $('body').addClass('no-parallax');
        }
        wWidth = $(window).width();
        wHeight = $(window).height();
    });

    $(window).resize(function() {
        MicrosoftIgnite.menuBehavior();
        wWidth = $(window).width();
        wHeight = $(window).height();
        if (!mobileTablet) {
            TweenLite.to($('[data-behavior="blade"]').first(), 0.5, {height: wHeight});
        }
        
        MicrosoftIgnite.menuBehavior();
    });
})(window.jQuery);